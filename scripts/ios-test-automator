#!/bin/bash

# iOS Test Automator CLI Wrapper
# This script provides a unified CLI interface for all components

set -e

VERSION="1.0.0"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"
CONFIG_DIR="${IOS_TEST_AUTOMATOR_CONFIG:-$HOME/.ios-test-automator}"

# Load environment from config
if [ -f "$CONFIG_DIR/.env" ]; then
    export $(grep -v '^#' "$CONFIG_DIR/.env" | xargs)
fi

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Helper functions
print_header() {
    echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${BLUE}  iOS Test Automator v${VERSION}${NC}"
    echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
}

print_success() {
    echo -e "${GREEN}âœ… $1${NC}"
}

print_error() {
    echo -e "${RED}âŒ $1${NC}"
}

print_info() {
    echo -e "${YELLOW}â„¹ï¸  $1${NC}"
}

# Check if Python virtual environment exists
check_venv() {
    local venv_dir="$1"
    if [ ! -d "$venv_dir" ]; then
        print_error "Virtual environment not found at: $venv_dir"
        print_info "Please install dependencies: pip install -r requirements.txt"
        exit 1
    fi
}

# Main command dispatcher
case "$1" in
    server|backend)
        print_header
        print_info "Starting FastAPI backend server..."
        cd "$PROJECT_ROOT/python-backend"

        # Check for venv
        if [ -d "venv/bin/python" ]; then
            source venv/bin/activate
        fi

        # Check for API key
        if [ -z "$ANTHROPIC_API_KEY" ]; then
            print_error "ANTHROPIC_API_KEY not set!"
            print_info "Run: ios-test-automator init"
            exit 1
        fi

        print_success "Backend starting on http://localhost:${BACKEND_PORT:-8000}"
        python main.py
        ;;

    ui|streamlit)
        print_header
        print_info "Launching Streamlit UI..."
        cd "$PROJECT_ROOT/streamlit-ui"

        # Check for venv
        if [ -d "venv/bin/python" ]; then
            source venv/bin/activate
        fi

        print_success "UI starting on http://localhost:${STREAMLIT_PORT:-8501}"
        streamlit run app.py --server.port="${STREAMLIT_PORT:-8501}"
        ;;

    rag)
        print_header
        print_info "RAG System Management"
        cd "$PROJECT_ROOT/python-rag"

        # Check for venv
        if [ -d ".venv/bin/python" ]; then
            source .venv/bin/activate
        fi

        python ios_rag_mvp.py "${@:2}"
        ;;

    init)
        print_header
        print_info "Initializing iOS Test Automator configuration..."

        # Create config directory
        mkdir -p "$CONFIG_DIR"
        mkdir -p "$CONFIG_DIR/rag_store"
        mkdir -p "$CONFIG_DIR/recordings"

        # Create .env file if it doesn't exist
        if [ ! -f "$CONFIG_DIR/.env" ]; then
            cat > "$CONFIG_DIR/.env" << 'EOF'
# iOS Test Automator Configuration
# Generated on $(date)

# Anthropic API Key (required)
# Get your key from: https://console.anthropic.com/
ANTHROPIC_API_KEY=

# Backend Configuration
BACKEND_PORT=8000
BACKEND_HOST=0.0.0.0

# RAG Configuration
RAG_PERSIST_DIR=$HOME/.ios-test-automator/rag_store
RAG_COLLECTION=ios_app
RAG_TOP_K=10

# Streamlit Configuration
STREAMLIT_PORT=8501

# Simulator Configuration
# Leave blank for auto-detection
SIMULATOR_ID=
SIMULATOR_NAME=iPhone 17
EOF
            print_success "Created config file at: $CONFIG_DIR/.env"
        else
            print_success "Config file already exists at: $CONFIG_DIR/.env"
        fi

        echo ""
        print_info "Directory structure:"
        echo "   ðŸ“ Config: $CONFIG_DIR/.env"
        echo "   ðŸ“ RAG Store: $CONFIG_DIR/rag_store"
        echo "   ðŸ“ Recordings: $CONFIG_DIR/recordings"
        echo ""
        print_header
        print_info "Next steps:"
        echo "   1. Add your Anthropic API key:"
        echo "      ${YELLOW}nano $CONFIG_DIR/.env${NC}"
        echo ""
        echo "   2. Index your iOS application:"
        echo "      ${YELLOW}ios-test-automator rag ingest --app-dir /path/to/your/app${NC}"
        echo ""
        echo "   3. Start the backend:"
        echo "      ${YELLOW}ios-test-automator server${NC}"
        echo ""
        echo "   4. Launch the UI (in new terminal):"
        echo "      ${YELLOW}ios-test-automator ui${NC}"
        echo ""
        ;;

    setup|install)
        print_header
        print_info "Installing dependencies..."

        # Install Python dependencies for all components
        echo ""
        print_info "Installing backend dependencies..."
        cd "$PROJECT_ROOT/python-backend"
        pip3 install -r requirements.txt

        echo ""
        print_info "Installing RAG dependencies..."
        cd "$PROJECT_ROOT/python-rag"
        pip3 install -r requirements.txt

        echo ""
        print_info "Installing UI dependencies..."
        cd "$PROJECT_ROOT/streamlit-ui"
        pip3 install -r requirements.txt

        echo ""
        print_success "All dependencies installed!"
        print_info "Run: ios-test-automator init"
        ;;

    status|health)
        print_header
        print_info "Checking system status..."
        echo ""

        # Check backend
        if curl -s http://localhost:8000/health > /dev/null 2>&1; then
            print_success "Backend is running (http://localhost:8000)"
        else
            print_error "Backend is not running"
        fi

        # Check Streamlit
        if curl -s http://localhost:8501 > /dev/null 2>&1; then
            print_success "UI is running (http://localhost:8501)"
        else
            print_error "UI is not running"
        fi

        # Check config
        if [ -f "$CONFIG_DIR/.env" ]; then
            print_success "Configuration exists"

            # Check API key
            if grep -q "ANTHROPIC_API_KEY=sk-" "$CONFIG_DIR/.env"; then
                print_success "API key is configured"
            else
                print_error "API key not configured"
            fi
        else
            print_error "Configuration not found"
            print_info "Run: ios-test-automator init"
        fi

        # Check RAG store
        if [ -d "$CONFIG_DIR/rag_store" ]; then
            print_success "RAG store directory exists"
        else
            print_error "RAG store not initialized"
        fi

        echo ""
        ;;

    config|configure)
        print_header
        print_info "Opening configuration file..."
        ${EDITOR:-nano} "$CONFIG_DIR/.env"
        ;;

    version|--version|-v)
        echo "iOS Test Automator v${VERSION}"
        ;;

    help|--help|-h|"")
        print_header
        echo "AI-powered iOS test automation with RAG-enhanced test generation"
        echo ""
        echo "${YELLOW}Usage:${NC}"
        echo "  ios-test-automator <command> [options]"
        echo ""
        echo "${YELLOW}Commands:${NC}"
        echo "  ${GREEN}server${NC}              Start the FastAPI backend server"
        echo "  ${GREEN}ui${NC}                  Launch the Streamlit web interface"
        echo "  ${GREEN}rag${NC} <subcommand>    Manage RAG vector store"
        echo "  ${GREEN}init${NC}                Initialize configuration and directories"
        echo "  ${GREEN}setup${NC}               Install all Python dependencies"
        echo "  ${GREEN}status${NC}              Check system health and status"
        echo "  ${GREEN}config${NC}              Edit configuration file"
        echo "  ${GREEN}version${NC}             Show version information"
        echo "  ${GREEN}help${NC}                Show this help message"
        echo ""
        echo "${YELLOW}RAG Subcommands:${NC}"
        echo "  ${GREEN}ingest${NC}              Index an iOS application codebase"
        echo "  ${GREEN}query${NC}               Query the RAG store"
        echo "  ${GREEN}stats${NC}               Show RAG store statistics"
        echo ""
        echo "${YELLOW}Examples:${NC}"
        echo "  # Initialize and configure"
        echo "  ios-test-automator init"
        echo "  ios-test-automator config"
        echo ""
        echo "  # Index your iOS app"
        echo "  ios-test-automator rag ingest --app-dir ~/Projects/MyApp/Sources"
        echo ""
        echo "  # Start services"
        echo "  ios-test-automator server              # Terminal 1"
        echo "  ios-test-automator ui                  # Terminal 2"
        echo ""
        echo "  # Check status"
        echo "  ios-test-automator status"
        echo ""
        echo "${YELLOW}Configuration:${NC}"
        echo "  Config file: $CONFIG_DIR/.env"
        echo "  RAG store:   $CONFIG_DIR/rag_store"
        echo "  Recordings:  $CONFIG_DIR/recordings"
        echo ""
        echo "${YELLOW}Documentation:${NC}"
        echo "  Quickstart:  cat $PROJECT_ROOT/QUICK_START.md"
        echo "  Full guide:  cat $PROJECT_ROOT/FULL_PIPELINE_GUIDE.md"
        echo ""
        ;;

    *)
        print_error "Unknown command: $1"
        echo "Run 'ios-test-automator help' for usage information"
        exit 1
        ;;
esac
